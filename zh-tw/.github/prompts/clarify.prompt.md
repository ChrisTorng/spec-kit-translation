---
description: 透過提出最多 5 個高度針對性的釐清問題，找出當前功能規格中未明確說明的區域，並將答案編碼回規格中。
---

使用者輸入可由代理直接提供或作為指令參數傳入 — 在繼續處理此提示前，您必須先考慮該輸入（若非空）。

使用者輸入:

$ARGUMENTS

目標：偵測並減少目前活動功能規格中的歧義或遺漏決策點，並將釐清事項直接記錄回規格檔案。

注意：此釐清工作流程預期在呼叫 `/plan` 之前執行（並完成）。若使用者明確表示要跳過釐清（例如進行探索性嘗試），可以繼續，但必須警告下游返工風險增加。

執行步驟：

1. 從 repo 根目錄僅執行**一次** `.specify/scripts/bash/check-prerequisites.sh --json --paths-only`（結合 `--json --paths-only` 模式 / `-Json -PathsOnly`）。解析最小 JSON 載荷欄位：
   - `FEATURE_DIR`
   - `FEATURE_SPEC`
   - （可選擷取 `IMPL_PLAN`, `TASKS` 以供後續串接流程使用。）
   - 若 JSON 解析失敗，中止並指示使用者重新執行 `/specify` 或驗證功能分支環境。

2. 載入目前的 spec 檔案。使用下列分類法執行結構化的歧義與覆蓋掃描。對每個分類標記狀態：Clear / Partial / Missing。產生用於優先排序的內部覆蓋地圖（除非不會提出任何問題，否則請勿輸出原始地圖）。

   功能範圍與行為：
   - 主要使用者目標與成功準則
   - 明確的非範圍宣告
   - 使用者角色 / 人物誌之區別

   領域與資料模型：
   - 實體、屬性、關係
   - 身分與唯一性規則
   - 生命週期 / 狀態轉換
   - 資料量 / 規模假設

   互動與使用者經驗流程：
   - 關鍵使用者旅程 / 序列
   - 錯誤/空狀態/載入狀態
   - 無障礙或在地化注意事項

   非功能性品質屬性：
   - 效能（延遲、吞吐目標）
   - 可擴充性（水平/垂直、限制）
   - 可用性與可靠性（上線時間、恢復預期）
   - 可觀測性（日誌、指標、追蹤訊號）
   - 安全與隱私（認證/授權、資料保護、威脅假設）
   - 合規 / 法規制約（如有）

   整合與外部相依：
   - 外部服務 / API 與失敗模式
   - 資料匯入/匯出格式
   - 協定 / 版本假設

   邊緣情況與失敗處理：
   - 負面情境
   - 速率限制 / 節流
   - 衝突解決（例如：並行編輯）

   約束與取捨：
   - 技術約束（語言、儲存、主機）
   - 明確的取捨或被否決的替代方案

   術語與一致性：
   - 正式的詞彙表條目
   - 避用的同義詞 / 被淘汰的術語

   完成信號：
   - 可測試的驗收準則
   - 可衡量的完成定義（Definition of Done）式指標

   雜項 / 佔位符：
   - TODO 標記 / 未解決的決策
   - 缺乏量化的模糊形容詞（例如「robust」、「intuitive」）

   對每個標記為 Partial 或 Missing 的分類，新增一個候選釐清問題，除非：
   - 釐清不會實質改變實作或驗證策略，或
   - 資訊較適合延後到規劃階段（在內部記錄）

3. 內部產生優先佇列的候選釐清問題（最多 5 個）。請勿一次輸出全部問題。套用下列限制：
    - 全會話最多 5 個問題。
    - 每個問題必須能以以下其中一種方式回答：
       * 短的多選題（2–5 個互斥選項），或
       * 一個單詞 / 短語回覆（明確限制：「回答 ≤5 個字詞」）。
   - 僅納入那些其答案會實質影響架構、資料建模、任務分解、測試設計、UX 行為、營運準備或合規驗證的問題。
   - 確保分類覆蓋的平衡：優先涵蓋未解決且影響最大的分類；當一個高影響領域（例如安全姿態）未解決時，避免提出兩個低影響問題。
   - 排除已回答的問題、瑣碎的樣式偏好，或計畫層級的執行細節（除非造成正確性阻塞）。
   - 偏好能降低下游返工風險或防止驗收測試錯位的釐清。
   - 若仍有超過 5 個分類未解決，依 (Impact * Uncertainty) 準則選出前 5 名。

4. 逐題互動詢問循環：
    - 每次僅呈現 一（1）個問題。
    - 對於多選題，請以 Markdown 表格呈現選項：

       | 選項 | 描述 |
       |------|------|
       | A | <選項 A 描述> |
       | B | <選項 B 描述> |
       | C | <選項 C 描述> |（視需要加入 D/E，最多 5 個）
       | Short | 提供其他短答（<=5 個字詞） |（僅在允許自由格式替代時包含）

    - 對於短答型（無實質離散選項），在問題下輸出一行：Format: Short answer (<=5 words)。  
    - 使用者回答後：
       * 驗證答案是否對應到某個選項或符合 ≤5 個字詞的限制。
       * 若有歧義，要求快速釐清（仍算同一題；不要推進至下一題）。
       * 一旦滿意，將其記錄於工作記憶（暫不寫回磁碟），並移至下一個佇列中的問題。
    - 在以下情況停止提出後續問題：
       * 所有關鍵歧義提前解析（剩餘佇列項目變得不必要），或
       * 使用者表示完成（例如輸入 "done"、"good"、"no more"），或
       * 已提出 5 個問題。
    - 切勿事先揭露未來的佇列問題。
    - 若一開始沒有有效問題，立即回報「無關鍵性歧義」。

5. 每接受一個答案後的整合（增量更新）：
    - 保持記憶中對規格（從一開始載入一次）與原始檔案內容的表示。
    - 本次會話中第一次整合的答案：
       * 確保存在 `## Clarifications` 區段（若缺少，依規格範本在最高層級的情境/概述章節之後建立）。
       * 在其下建立（若不存在）今日的子標題：`### Session YYYY-MM-DD`。
    - 在接受後立即附加一行項目符號：`- Q: <question> → A: <final answer>`。
    - 然後立即將釐清套用到最適合的章節：
       * 功能性歧義 → 在功能需求中更新或新增項目符號。
       * 使用者互動 / 角色區分 → 在使用者故事或角色子段落（若存在）中更新角色、限制或情境。
       * 資料形狀 / 實體 → 在資料模型中更新（新增欄位、類型、關係），保持順序；簡明註記新增限制。
       * 非功能性約束 → 在非功能 / 品質屬性章節新增或修改可衡量準則（將模糊形容詞轉為量化指標或明確目標）。
       * 邊緣情況 / 負流程 → 在邊緣情況 / 錯誤處理下新增項目（若範本已有佔位，則建立該子段落）。
       * 術語衝突 → 在規格中統一術語；僅在必要時保留原稱呼一次，格式為 `(formerly referred to as "X")`。
    - 若釐清使先前的不明確陳述失效，請取代該陳述而非重複；不要保留過時或互相矛盾的文字。
    - 每次整合後即將規格檔案儲存（原子覆寫），以降低上下文遺失風險。
    - 保留格式：不要重新排序無關段落；維持標題階層結構。
    - 保持每次插入的釐清簡潔且可測試（避免敘事偏離）。

6. 驗證（於每次寫入後及最終通過時執行）：
   - 釐清會話每個接受的答案恰為一個項目符號（無重複）。
   - 總提問數（且被接受） ≤ 5。
   - 已更新的章節中，不應殘留原本欲以新答案解決的模糊佔位。
   - 不得保留先前相互矛盾的陳述（掃描以移除現已無效的替代選項）。
   - Markdown 結構有效；僅允許新增的標題為：`## Clarifications`、`### Session YYYY-MM-DD`。
   - 術語一致性：在所有更新章節中使用相同的正式術語。

7. 將更新後的規格寫回 `FEATURE_SPEC`。

8. 回報完成（在詢問循環結束或提早終止後）：
   - 已問與已答問題數量。
   - 已更新規格的路徑。
   - 涉及的章節（列出名稱）。
   - 覆蓋摘要表，列出每個分類的狀態：Resolved（原為 Partial/Missing 且已處理）、Deferred（超出問題配額或較適合於規劃時處理）、Clear（原已足夠）、Outstanding（仍為 Partial/Missing 但屬低影響）。
   - 若仍有 Outstanding 或 Deferred，建議是否繼續執行 `/plan` 或稍後在規劃後再次執行 `/clarify`。
   - 建議的下一個指令。

行為規則：
- 若未發現有意義的歧義（或所有潛在問題皆為低影響），回應：「No critical ambiguities detected worth formal clarification.」並建議繼續。
- 若規格檔案遺失，指示使用者先執行 `/specify`（此處不要建立新規格）。
- 切勿超過總計 5 個問題（對單一問題的釐清重試不計入新題數）。
- 除非缺少會阻礙功能明確性，否則避免推測性的技術堆疊問題。
- 尊重使用者提前終止訊號（例如 "stop"、"done"、"proceed"）。
- 若因完全覆蓋而未提問，輸出一份精簡的覆蓋摘要（所有分類為 Clear），然後建議前進。
- 若配額已滿但仍有未解決的高影響分類，於 Deferred 中明確標註並說明理由。

優先順序依據之背景：$ARGUMENTS

翻譯完成後，請將需要固定翻譯標籤的對照更新 GEMINI.md 檔案。